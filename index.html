<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบริหารคลังยาและเวชภัณฑ์ (Professional Pharmacy Stock)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS (XLSX) for Excel Import/Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; color: #334155; }
        
        /* Components */
        .glass-panel { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
        .btn-action { transition: all 0.2s; }
        .btn-action:active { transform: scale(0.98); }
        .modal-bg { background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); }
        
        /* Badges */
        .badge { padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }
        .badge-drug { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .badge-material { background-color: #fce7f3; color: #9d174d; border: 1px solid #fbcfe8; }
        .badge-equip { background-color: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        
        /* Form */
        .form-label { display: block; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 4px; }
        .form-input { width: 100%; border-radius: 8px; border: 1px solid #cbd5e1; padding: 8px 12px; font-size: 0.9rem; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #0d9488; ring: 2px solid #0d9488; }
        .form-section-title { font-size: 0.95rem; font-weight: 700; color: #0f766e; border-bottom: 2px solid #ccfbf1; padding-bottom: 4px; margin-bottom: 12px; margin-top: 8px; }

        /* Helpers */
        body:not(.logged-in) .admin-only { display: none !important; }
        body.logged-in .public-only { display: none !important; }
        .clickable-row:hover { background-color: #f0fdfa !important; cursor: pointer; }

        /* Mobile Sidebar Transition */
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        aside { transition: transform 0.3s ease-in-out; }

        /* Print Styles */
        @media print {
            @page { size: A4; margin: 1cm; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            nav, #sidebar-overlay, #mobile-menu-btn, .no-print, .btn-action, button:not(.hidden) { display: none !important; }
            aside { display: none !important; }
            main { margin: 0 !important; padding: 0 !important; overflow: visible !important; height: auto !important; width: 100% !important; }
            .page-view { display: none; }
            .page-view:not(.hidden) { display: block !important; }
            #detail-modal:not(.hidden) { position: static !important; background: white !important; padding: 0 !important; display: block !important; height: auto !important; overflow: visible !important; }
            #detail-modal .bg-white { box-shadow: none !important; max-width: 100% !important; max-height: none !important; overflow: visible !important; }
            .modal-bg { background: white !important; position: static !important; }
            table { width: 100%; border-collapse: collapse; font-size: 10pt; }
            th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: left; }
            thead { background-color: #f0f0f0 !important; color: black !important; }
            .glass-panel { box-shadow: none; border: none; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-slate-50">

    <!-- LOGIN MODAL (Z-Index 60) -->
    <div id="login-modal" class="fixed inset-0 z-[60] flex items-center justify-center modal-bg hidden no-print">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 relative">
            <button onclick="toggleLoginModal(false)" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-teal-50 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-teal-100">
                    <i class="fa-solid fa-user-doctor text-3xl text-teal-600"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">เข้าสู่ระบบเภสัชกร</h1>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="text" id="username" class="form-input" placeholder="Username (admin)" value="admin">
                <input type="password" id="password" class="form-input" placeholder="Password (1234)" value="1234">
                <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2.5 rounded-lg shadow-md btn-action">Login</button>
            </form>
        </div>
    </div>

    <!-- DETAIL MODAL (Z-Index 60) -->
    <div id="detail-modal" class="fixed inset-0 z-[60] flex items-center justify-center modal-bg hidden" onclick="if(event.target === this) toggleDetailModal(false)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl mx-4 flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center rounded-t-xl no-print">
                <div class="flex items-center gap-3">
                    <div class="bg-teal-100 p-2 rounded-lg text-teal-700"><i class="fa-solid fa-file-prescription text-xl"></i></div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800" id="detail-trade-header">รายละเอียด</h2>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="text-gray-500 hover:text-blue-600 px-3 py-1 rounded border border-gray-200 hover:bg-gray-50"><i class="fa-solid fa-print"></i> Print</button>
                    <button onclick="toggleDetailModal(false)" class="text-gray-400 hover:text-red-500 px-2"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
            </div>
            
            <div class="p-6 overflow-y-auto bg-slate-50 flex-1" id="detail-print-area">
                <div class="mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800" id="detail-trade">-</h1>
                            <p class="text-lg text-gray-600 font-medium" id="detail-generic">-</p>
                        </div>
                        <span id="detail-type-badge" class="badge bg-gray-200 text-gray-700">Type</span>
                    </div>
                    <p class="text-sm text-gray-400 mt-1">รหัส/ID: <span id="detail-code24" class="font-mono text-gray-600">-</span></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                        <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">ข้อมูลทั่วไป (General)</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-500">รูปแบบ/หน่วย:</span> <span class="font-semibold" id="detail-form">-</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">สเปค/ความแรง:</span> <span class="font-semibold" id="detail-strength">-</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">หมวดหมู่:</span> <span id="detail-cat">-</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">ความสำคัญ (VED):</span> <span id="detail-ved">-</span></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                        <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">สถานะคงคลัง (Inventory)</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-500">Lot/Serial:</span> <span class="font-mono font-bold text-blue-600" id="detail-lot">-</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Exp/Warranty:</span> <span class="font-bold text-red-600" id="detail-exp">-</span></div>
                            <div class="mt-2 pt-2 border-t flex justify-between items-end">
                                <span class="text-gray-500">คงเหลือ:</span>
                                <span class="text-2xl font-bold text-teal-700" id="detail-qty">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                        <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">การจัดซื้อ (Procurement)</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-500">ผู้ผลิต/ผู้ขาย:</span> <span class="font-medium truncate w-32 text-right" id="detail-mfg">-</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Invoice No.:</span> <span class="font-medium" id="detail-inv">-</span></div>
                             <div class="flex justify-between"><span class="text-gray-500">ปีงบประมาณ:</span> <span class="font-medium" id="detail-budget">-</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">ราคา/หน่วย:</span> <span class="font-bold" id="detail-price">-</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border shadow-sm overflow-hidden">
                    <div class="px-4 py-2 bg-gray-100 border-b text-xs font-bold text-gray-500 uppercase">Transaction Log</div>
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                            <tr><th class="px-4 py-2">Date/Time</th><th class="px-4 py-2">Action</th><th class="px-4 py-2 text-right">Qty</th><th class="px-4 py-2">Note</th></tr>
                        </thead>
                        <tbody id="detail-history-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <button id="mobile-menu-btn" onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-teal-600 focus:outline-none p-2 rounded hover:bg-gray-100">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <div class="bg-teal-600 text-white p-2 rounded-lg"><i class="fa-solid fa-staff-snake text-lg"></i></div>
                <div>
                    <h1 class="font-bold text-gray-800 text-lg leading-tight">Smart Pharma Stock</h1>
                    <p class="text-xs text-teal-600 font-semibold">Professional Edition</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleLoginModal(true)" class="public-only bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-teal-700 transition">
                    <i class="fa-solid fa-key mr-2"></i> Login
                </button>
                <div class="admin-only flex items-center gap-3">
                    <span class="hidden sm:inline text-xs font-bold text-teal-700 bg-teal-50 px-3 py-1 rounded-full border border-teal-100">Pharmacist (Admin)</span>
                    <button onclick="logout()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-power-off text-lg"></i></button>
                </div>
                <button onclick="fetchData()" class="text-gray-400 hover:text-teal-600"><i class="fa-solid fa-sync text-lg"></i></button>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative">
        <div id="sidebar-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden cursor-pointer transition-opacity duration-300 opacity-0" style="opacity: 0;"></div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="admin-only fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 flex flex-col transform -translate-x-full md:translate-x-0 md:relative md:flex transition-transform duration-300">
             <div class="p-4 flex justify-between items-center md:hidden border-b bg-gray-50">
                <span class="font-bold text-teal-700 flex items-center gap-2"><i class="fa-solid fa-bars"></i> Menu</span>
                <button onclick="toggleSidebar(false)" class="text-gray-400 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition"><i class="fa-solid fa-times text-lg"></i></button>
            </div>
            
            <div class="p-4 space-y-1 overflow-y-auto flex-1">
                <p class="px-3 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 mt-2">Overview</p>
                <button onclick="switchTab('dashboard')" class="menu-item w-full text-left px-3 py-2 rounded-lg text-gray-600 hover:bg-teal-50 hover:text-teal-700 font-medium flex items-center gap-3 transition">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> ภาพรวม (Dashboard)
                </button>
                <button onclick="switchTab('dashboard', 'Drug'); scrollToPanel('panel-main')" class="menu-item w-full text-left px-3 py-1.5 rounded-lg text-gray-500 hover:bg-teal-50 hover:text-teal-600 text-sm flex items-center gap-3 transition pl-10">
                    <i class="fa-solid fa-pills text-[0.8rem] w-4 text-center"></i> คลังยา (Drugs)
                </button>
                 <button onclick="switchTab('dashboard', 'Material'); scrollToPanel('panel-main')" class="menu-item w-full text-left px-3 py-1.5 rounded-lg text-gray-500 hover:bg-teal-50 hover:text-teal-600 text-sm flex items-center gap-3 transition pl-10">
                    <i class="fa-solid fa-bandage text-[0.8rem] w-4 text-center"></i> วัสดุการแพทย์
                </button>
                 <button onclick="switchTab('dashboard', 'Equipment'); scrollToPanel('panel-main')" class="menu-item w-full text-left px-3 py-1.5 rounded-lg text-gray-500 hover:bg-teal-50 hover:text-teal-600 text-sm flex items-center gap-3 transition pl-10">
                    <i class="fa-solid fa-stethoscope text-[0.8rem] w-4 text-center"></i> ครุภัณฑ์การแพทย์
                </button>
                
                <p class="px-3 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 mt-4">Operation</p>
                <button onclick="switchTab('inbound')" class="menu-item w-full text-left px-3 py-2 rounded-lg text-gray-600 hover:bg-teal-50 hover:text-teal-700 font-medium flex items-center gap-3 transition">
                    <i class="fa-solid fa-truck-medical w-5 text-center"></i> 1. รับยาเข้า (Inbound)
                </button>
                <button onclick="switchTab('transfer')" class="menu-item w-full text-left px-3 py-2 rounded-lg text-gray-600 hover:bg-teal-50 hover:text-teal-700 font-medium flex items-center gap-3 transition">
                    <i class="fa-solid fa-dolly w-5 text-center"></i> 2. เบิกห้องยา (Transfer)
                </button>
                <button onclick="switchTab('outbound')" class="menu-item w-full text-left px-3 py-2 rounded-lg text-gray-600 hover:bg-teal-50 hover:text-teal-700 font-medium flex items-center gap-3 transition">
                    <i class="fa-solid fa-hand-holding-medical w-5 text-center"></i> 3. จ่ายยา (Dispensing)
                </button>
                
                <p class="px-3 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 mt-4">Management</p>
                <button onclick="switchTab('adjust')" class="menu-item w-full text-left px-3 py-2 rounded-lg text-gray-600 hover:bg-red-50 hover:text-red-700 font-medium flex items-center gap-3 transition">
                    <i class="fa-solid fa-wrench w-5 text-center"></i> 4. ปรับยอด (Adjust)
                </button>
                <button onclick="switchTab('import')" class="menu-item w-full text-left px-3 py-2 rounded-lg text-blue-600 bg-blue-50 hover:bg-blue-100 font-medium flex items-center gap-3 transition border border-blue-100">
                    <i class="fa-solid fa-file-excel w-5 text-center"></i> 5. นำเข้าข้อมูล (Import)
                </button>

                 <p class="px-3 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 mt-4">Reports</p>
                <button onclick="switchTab('alerts')" class="menu-item w-full text-left px-3 py-2 rounded-lg text-orange-600 bg-orange-50 hover:bg-orange-100 font-medium flex items-center gap-3 transition border border-orange-100">
                    <i class="fa-solid fa-bell w-5 text-center"></i> 6. แจ้งเตือน (Alerts)
                </button>
                <button onclick="switchTab('reports')" class="menu-item w-full text-left px-3 py-2 rounded-lg text-green-600 bg-green-50 hover:bg-green-100 font-medium flex items-center gap-3 transition border border-green-100">
                    <i class="fa-solid fa-file-export w-5 text-center"></i> 7. รายงาน/ส่งออก
                </button>
            </div>
            <div class="p-4 border-t text-center text-xs text-gray-400">
                v1.5.0 Multi-Type Transfer
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 relative w-full" id="main-content">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="page-view space-y-6 max-w-7xl mx-auto">
                <!-- Banner -->
                <div class="public-only bg-gradient-to-r from-teal-500 to-emerald-600 rounded-xl p-6 text-white shadow-lg flex items-center gap-4">
                    <div class="bg-white/20 p-3 rounded-full"><i class="fa-solid fa-eye text-2xl"></i></div>
                    <div>
                        <h3 class="text-lg font-bold">Dashboard แสดงข้อมูลยาและเวชภัณฑ์</h3>
                        <p class="text-teal-100 text-sm">เลือกประเภทรายการจากเมนูด้านซ้ายเพื่อกรองข้อมูล</p>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass-panel p-4 border-l-4 border-blue-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">คลังใหญ่ (Main)</p>
                        <h2 class="text-2xl font-bold text-gray-800 mt-1" id="stat-main-items">0</h2>
                    </div>
                    <div class="glass-panel p-4 border-l-4 border-teal-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">ห้องยา (OPD)</p>
                        <h2 class="text-2xl font-bold text-gray-800 mt-1" id="stat-opd-items">0</h2>
                    </div>
                    <div class="glass-panel p-4 border-l-4 border-orange-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">ใกล้หมดอายุ</p>
                        <h2 class="text-2xl font-bold text-gray-800 mt-1" id="stat-expire">0</h2>
                    </div>
                     <div class="glass-panel p-4 border-l-4 border-gray-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">มูลค่ารวม</p>
                        <h2 class="text-2xl font-bold text-gray-800 mt-1" id="stat-value">0</h2>
                    </div>
                </div>

                <!-- Search & Header -->
                <div class="flex justify-between items-center gap-4">
                    <h2 class="text-xl font-bold text-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-layer-group text-teal-600"></i>
                        <span id="dashboard-title">ภาพรวมทั้งหมด (All Items)</span>
                    </h2>
                    <div class="relative w-64">
                        <input type="text" id="search-input" onkeyup="filterTables()" placeholder="ค้นหาชื่อ, Lot..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <!-- Tables -->
                <div class="grid xl:grid-cols-2 gap-6">
                    <div id="panel-main" class="glass-panel flex flex-col h-[500px]">
                        <div class="p-4 border-b bg-gray-50 rounded-t-xl font-bold text-gray-700 flex justify-between">
                            <span>Stock คลังใหญ่ (Main)</span>
                            <span class="text-xs font-normal bg-gray-200 px-2 py-1 rounded text-gray-600" id="count-main">0 Items</span>
                        </div>
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-sm text-left" id="table-main">
                                <thead class="bg-white sticky top-0 shadow-sm text-xs uppercase text-gray-500">
                                    <tr><th class="px-4 py-3">รายการ (Name)</th><th class="px-4 py-3">Lot/Exp</th><th class="px-4 py-3 text-right">Qty</th></tr>
                                </thead>
                                <tbody class="divide-y text-gray-600"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="panel-opd" class="glass-panel flex flex-col h-[500px]">
                        <div class="p-4 border-b bg-gray-50 rounded-t-xl font-bold text-gray-700 flex justify-between">
                            <span>Stock ห้องยา (OPD)</span>
                            <span class="text-xs font-normal bg-gray-200 px-2 py-1 rounded text-gray-600" id="count-opd">0 Items</span>
                        </div>
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-sm text-left" id="table-opd">
                                <thead class="bg-white sticky top-0 shadow-sm text-xs uppercase text-gray-500">
                                    <tr><th class="px-4 py-3">รายการ (Name)</th><th class="px-4 py-3">สถานะ</th><th class="px-4 py-3 text-right">Qty</th></tr>
                                </thead>
                                <tbody class="divide-y text-gray-600"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: INBOUND (Updated with Tabs) -->
            <div id="view-inbound" class="page-view admin-only hidden">
                <div class="max-w-4xl mx-auto glass-panel p-6">
                    <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-truck-medical text-blue-600"></i> รับเข้าคลัง (Inbound)
                        </h2>
                        
                        <!-- Search Existing -->
                        <div class="relative w-full md:w-80">
                            <i class="fa-solid fa-search absolute left-3 top-3 text-blue-400 z-10"></i>
                            <input type="text" id="inbound-search-existing" list="existing-items-list" class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-blue-50/50" placeholder="พิมพ์ชื่อรายการเดิม เพื่อ Auto Fill..." onchange="autoFillInbound()">
                            <datalist id="existing-items-list"></datalist>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex space-x-1 rounded-xl bg-gray-100 p-1 mb-6">
                        <button onclick="switchInboundTab('drug')" id="tab-btn-drug" class="w-full rounded-lg py-2.5 text-sm font-bold leading-5 text-gray-700 ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 shadow bg-white text-blue-700">
                            <i class="fa-solid fa-pills mr-2"></i> ยา (Drugs)
                        </button>
                        <button onclick="switchInboundTab('material')" id="tab-btn-material" class="w-full rounded-lg py-2.5 text-sm font-medium leading-5 text-gray-500 hover:bg-white/[0.12] hover:text-white focus:outline-none focus:ring-2">
                            <i class="fa-solid fa-bandage mr-2"></i> วัสดุ (Materials)
                        </button>
                        <button onclick="switchInboundTab('equipment')" id="tab-btn-equipment" class="w-full rounded-lg py-2.5 text-sm font-medium leading-5 text-gray-500 hover:bg-white/[0.12] hover:text-white focus:outline-none focus:ring-2">
                            <i class="fa-solid fa-stethoscope mr-2"></i> ครุภัณฑ์ (Equipment)
                        </button>
                    </div>

                    <!-- FORM 1: DRUGS (Original) -->
                    <div id="form-section-drug">
                        <form id="form-inbound-drug" class="space-y-6">
                            <input type="hidden" name="itemType" value="Drug">
                            <div>
                                <h3 class="form-section-title">1. ข้อมูลยา (Drug Info)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="form-label">รหัสยา 24 หลัก (24-digit Code)</label><input type="text" name="drugCode24" id="drug-code24" class="form-input font-mono" maxlength="24"></div>
                                    <div><label class="form-label">ชื่อสามัญ (Generic Name) *</label><input type="text" name="genericName" id="drug-generic" required class="form-input" placeholder="e.g. Paracetamol"></div>
                                    <div><label class="form-label">ชื่อการค้า (Trade Name)</label><input type="text" name="tradeName" id="drug-trade" class="form-input" placeholder="e.g. Sara"></div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="form-label">รูปแบบ (Form)</label>
                                            <select name="dosageForm" id="drug-form" class="form-input bg-white">
                                                <option value="Tablet">Tablet (เม็ด)</option>
                                                <option value="Capsule">Capsule (แคปซูล)</option>
                                                <option value="Syrup">Syrup (ยาน้ำ)</option>
                                                <option value="Injection">Injection (ยาฉีด)</option>
                                                <option value="Cream">Cream (ครีม)</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div><label class="form-label">ความแรง (Strength)</label><input type="text" name="strength" id="drug-strength" class="form-input" placeholder="e.g. 500 mg"></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="form-label">กลุ่มบัญชี</label>
                                            <select name="category" id="drug-cat" class="form-input bg-white">
                                                <option value="ED">ED (ยาในบัญชี)</option>
                                                <option value="NED">NED (ยานอกบัญชี)</option>
                                            </select>
                                        </div>
                                        <div><label class="form-label">VED Analysis</label>
                                            <select name="ved" id="drug-ved" class="form-input bg-white">
                                                <option value="V">Vital</option>
                                                <option value="E">Essential</option>
                                                <option value="N">Non-essential</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Shared Stock Section (Duplicated for simplicity in ID handling) -->
                            <div class="stock-section">
                                <h3 class="form-section-title">2. การจัดซื้อและสต็อก (Stock & Procurement)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label class="form-label">Lot No. *</label><input type="text" name="lot" required class="form-input"></div>
                                    <div><label class="form-label">วันหมดอายุ *</label><input type="date" name="expDate" required class="form-input"></div>
                                    <div><label class="form-label text-blue-700">จำนวนรับ (Qty) *</label><input type="number" name="qty" required min="1" class="form-input border-blue-300 bg-blue-50 font-bold"></div>
                                    
                                    <div><label class="form-label">ราคา/หน่วย (บาท)</label><input type="number" name="price" step="0.01" class="form-input"></div>
                                    <div><label class="form-label">Invoice No.</label><input type="text" name="invoiceNo" class="form-input"></div>
                                    <div><label class="form-label">ปีงบประมาณ</label><input type="text" name="budgetYear" class="form-input" value="2567"></div>
                                    
                                    <div><label class="form-label">ผู้ผลิต (Manufacturer)</label><input type="text" name="manufacturer" class="form-input"></div>
                                    <div><label class="form-label">ผู้จำหน่าย (Supplier)</label><input type="text" name="supplier" class="form-input"></div>
                                    <div><label class="form-label">วันที่รับเข้า</label><input type="date" name="inboundDate" required class="form-input"></div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">บันทึกยาเข้าคลัง</button>
                        </form>
                    </div>

                    <!-- FORM 2: MATERIALS -->
                    <div id="form-section-material" class="hidden">
                         <form id="form-inbound-material" class="space-y-6">
                            <input type="hidden" name="itemType" value="Material">
                            <input type="hidden" name="category" value="SUP"> <!-- Default Category for Supplies -->
                            <div>
                                <h3 class="form-section-title text-pink-700 border-pink-200">1. ข้อมูลวัสดุ (Material Info)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="form-label">รหัสวัสดุ (Material Code)</label><input type="text" name="drugCode24" id="mat-code" class="form-input font-mono" placeholder="ถ้ามี"></div>
                                    <div><label class="form-label">ชื่อวัสดุ (Material Name) *</label><input type="text" name="genericName" id="mat-name" required class="form-input" placeholder="e.g. สำลี, เข็มฉีดยา"></div>
                                    <div><label class="form-label">ยี่ห้อ/รุ่น (Brand/Model)</label><input type="text" name="tradeName" id="mat-brand" class="form-input"></div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="form-label">หน่วยนับ (Unit)</label>
                                            <select name="dosageForm" id="mat-unit" class="form-input bg-white">
                                                <option value="Piece">Piece (ชิ้น/อัน)</option>
                                                <option value="Box">Box (กล่อง)</option>
                                                <option value="Pack">Pack (แพ็ค)</option>
                                                <option value="Roll">Roll (ม้วน)</option>
                                                <option value="Set">Set (ชุด)</option>
                                                <option value="Bottle">Bottle (ขวด)</option>
                                                <option value="Dozen">Dozen (โหล)</option>
                                            </select>
                                        </div>
                                        <div><label class="form-label">ขนาด/สเปค (Size/Spec)</label><input type="text" name="strength" id="mat-spec" class="form-input" placeholder="e.g. 1 นิ้ว, No.18"></div>
                                    </div>
                                </div>
                            </div>
                             <div class="stock-section">
                                <h3 class="form-section-title">2. การจัดซื้อและสต็อก</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label class="form-label">Lot No. *</label><input type="text" name="lot" required class="form-input"></div>
                                    <div><label class="form-label">วันหมดอายุ</label><input type="date" name="expDate" required class="form-input"></div>
                                    <div><label class="form-label text-pink-700">จำนวนรับ (Qty) *</label><input type="number" name="qty" required min="1" class="form-input border-pink-300 bg-pink-50 font-bold"></div>
                                    
                                    <div><label class="form-label">ราคา/หน่วย</label><input type="number" name="price" step="0.01" class="form-input"></div>
                                    <div><label class="form-label">Invoice No.</label><input type="text" name="invoiceNo" class="form-input"></div>
                                    <div><label class="form-label">ปีงบประมาณ</label><input type="text" name="budgetYear" class="form-input" value="2567"></div>
                                    
                                    <div><label class="form-label">ผู้จำหน่าย</label><input type="text" name="supplier" class="form-input"></div>
                                    <div class="col-span-2"><label class="form-label">วันที่รับเข้า</label><input type="date" name="inboundDate" required class="form-input"></div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-pink-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-pink-700 transition">บันทึกวัสดุเข้าคลัง</button>
                        </form>
                    </div>

                    <!-- FORM 3: EQUIPMENT -->
                    <div id="form-section-equipment" class="hidden">
                        <form id="form-inbound-equipment" class="space-y-6">
                            <input type="hidden" name="itemType" value="Equipment">
                            <input type="hidden" name="category" value="EQUIP">
                            <div>
                                <h3 class="form-section-title text-orange-700 border-orange-200">1. ข้อมูลครุภัณฑ์ (Asset Info)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="form-label">เลขครุภัณฑ์ (Asset Code) *</label><input type="text" name="drugCode24" id="eq-code" class="form-input font-mono" placeholder="เลขทะเบียนครุภัณฑ์"></div>
                                    <div><label class="form-label">ชื่อครุภัณฑ์ (Equipment Name) *</label><input type="text" name="genericName" id="eq-name" required class="form-input" placeholder="e.g. เครื่องวัดความดัน"></div>
                                    <div><label class="form-label">ยี่ห้อ/รุ่น (Brand/Model)</label><input type="text" name="tradeName" id="eq-brand" class="form-input"></div>
                                    <div><label class="form-label">หน่วยนับ</label><input type="text" name="dosageForm" value="เครื่อง/ชุด" class="form-input bg-gray-100" readonly></div>
                                </div>
                            </div>
                             <div class="stock-section">
                                <h3 class="form-section-title">2. รายละเอียดทรัพย์สิน</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label class="form-label">Serial No. (แทน Lot) *</label><input type="text" name="lot" required class="form-input" placeholder="S/N ของเครื่อง"></div>
                                    <div><label class="form-label">วันหมดประกัน (Warranty) *</label><input type="date" name="expDate" required class="form-input"></div>
                                    <div><label class="form-label text-orange-700">จำนวน (Qty) *</label><input type="number" name="qty" required min="1" value="1" class="form-input border-orange-300 bg-orange-50 font-bold"></div>
                                    
                                    <div><label class="form-label">ราคาซื้อ</label><input type="number" name="price" step="0.01" class="form-input"></div>
                                    <div><label class="form-label">ผู้จำหน่าย/บริษัท</label><input type="text" name="supplier" class="form-input"></div>
                                    <div><label class="form-label">ปีงบประมาณ</label><input type="text" name="budgetYear" class="form-input" value="2567"></div>
                                    
                                    <div class="col-span-3"><label class="form-label">วันที่รับเข้า/ติดตั้ง</label><input type="date" name="inboundDate" required class="form-input w-1/3"></div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-orange-700 transition">บันทึกครุภัณฑ์</button>
                        </form>
                    </div>

                </div>
            </div>

            <!-- VIEW: TRANSFER (Updated with Filters) -->
            <div id="view-transfer" class="page-view admin-only hidden">
                <div class="max-w-2xl mx-auto glass-panel p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fa-solid fa-dolly text-teal-600 mr-2"></i> เบิกยาเข้าห้องยา (Transfer)</h2>
                    
                    <!-- Filter Tabs -->
                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                        <button onclick="setTransferFilter('All')" class="px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold transition">All</button>
                        <button onclick="setTransferFilter('Drug')" class="px-3 py-1 text-sm rounded-full bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold transition"><i class="fa-solid fa-pills mr-1"></i> ยา</button>
                        <button onclick="setTransferFilter('Material')" class="px-3 py-1 text-sm rounded-full bg-pink-100 hover:bg-pink-200 text-pink-700 font-bold transition"><i class="fa-solid fa-bandage mr-1"></i> วัสดุ</button>
                        <button onclick="setTransferFilter('Equipment')" class="px-3 py-1 text-sm rounded-full bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold transition"><i class="fa-solid fa-stethoscope mr-1"></i> ครุภัณฑ์</button>
                    </div>

                    <form id="form-transfer" class="space-y-4">
                        <div>
                            <label class="form-label">เลือกรายการ (จากคลังใหญ่)</label>
                            <select id="transfer-select-item" class="form-input bg-white" onchange="updateTransferMax()"></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">จำนวนเบิก</label>
                                <input type="number" id="transfer-qty" required class="form-input font-bold text-teal-700">
                                <p class="text-xs text-gray-500 mt-1">คงเหลือ: <span id="transfer-max">0</span></p>
                            </div>
                            <div>
                                <label class="form-label">วันที่เบิก</label>
                                <input type="date" id="transfer-date" required class="form-input">
                            </div>
                        </div>
                        <div><label class="form-label">หมายเหตุ/ผู้เบิก</label><input type="text" id="transfer-remark" class="form-input"></div>
                        <button type="submit" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold shadow hover:bg-teal-700">ยืนยันการเบิก</button>
                    </form>
                </div>
            </div>

            <!-- VIEW: OUTBOUND (Updated with Filters) -->
            <div id="view-outbound" class="page-view admin-only hidden">
                <div class="max-w-2xl mx-auto glass-panel p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fa-solid fa-hand-holding-medical text-green-600 mr-2"></i> จ่ายยา (Dispensing)</h2>
                    
                     <!-- Filter Tabs -->
                     <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                        <button onclick="setOutboundFilter('All')" class="px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold transition">All</button>
                        <button onclick="setOutboundFilter('Drug')" class="px-3 py-1 text-sm rounded-full bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold transition"><i class="fa-solid fa-pills mr-1"></i> ยา</button>
                        <button onclick="setOutboundFilter('Material')" class="px-3 py-1 text-sm rounded-full bg-pink-100 hover:bg-pink-200 text-pink-700 font-bold transition"><i class="fa-solid fa-bandage mr-1"></i> วัสดุ</button>
                        <button onclick="setOutboundFilter('Equipment')" class="px-3 py-1 text-sm rounded-full bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold transition"><i class="fa-solid fa-stethoscope mr-1"></i> ครุภัณฑ์</button>
                    </div>

                    <div class="space-y-5">
                        <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                            <label class="form-label text-green-800">เลือกรายการจาก OPD Stock</label>
                            <select id="outbound-select-item" class="form-input bg-white" onchange="updateOutboundMax()"></select>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="form-label">จำนวนที่จ่าย</label>
                                <input type="number" id="outbound-qty" required class="form-input font-bold text-gray-800 text-lg">
                                <p class="text-xs text-gray-500 mt-1">คงเหลือ OPD: <span id="outbound-max">0</span></p>
                            </div>
                        </div>
                         <div><label class="form-label">ผู้จ่ายยา (Dispenser)</label><input type="text" id="outbound-by" value="Admin" class="form-input"></div>
                        <button onclick="submitOutbound()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow hover:bg-green-700">บันทึกการจ่าย</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: ADJUST -->
            <div id="view-adjust" class="page-view admin-only hidden">
                <div class="max-w-2xl mx-auto glass-panel p-6 border-t-4 border-red-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fa-solid fa-wrench text-red-600 mr-2"></i> ปรับยอด (Adjust)</h2>
                    <form id="form-adjust" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">คลัง</label><select id="adjust-location" class="form-input bg-white" onchange="loadAdjustItems()"><option value="Main">Main</option><option value="OPD">OPD</option></select></div>
                            <div><label class="form-label">รายการ</label><select id="adjust-item" class="form-input bg-white"><option>Loading...</option></select></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">ประเภท</label><select id="adjust-type" class="form-input bg-white"><option value="Remove">ตัดออก (เสียหาย/หมดอายุ)</option><option value="Add">รับคืน/เกิน</option></select></div>
                            <div><label class="form-label">จำนวน</label><input type="number" id="adjust-qty" required class="form-input"></div>
                        </div>
                        <div><label class="form-label">สาเหตุ</label><input type="text" id="adjust-reason" required class="form-input"></div>
                        <button type="submit" class="w-full bg-gray-700 text-white py-3 rounded-xl font-bold hover:bg-gray-800">ยืนยันปรับยอด</button>
                    </form>
                </div>
            </div>

            <!-- VIEW: IMPORT (Excel) -->
            <div id="view-import" class="page-view admin-only hidden">
                <div class="max-w-4xl mx-auto glass-panel p-8">
                    <div class="flex items-center gap-4 mb-8 border-b pb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 text-2xl"><i class="fa-solid fa-file-excel"></i></div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">นำเข้าข้อมูลจาก Excel</h2>
                            <p class="text-gray-500">ระบบ Batch Import สำหรับข้อมูลจำนวนมาก</p>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="form-label">1. เลือกประเภทการนำเข้า</label>
                        <select id="import-type" class="form-input bg-white" onchange="updateTemplateInfo()">
                            <option value="BATCH_INBOUND">📦 รับยาเข้า (Standard Inbound)</option>
                            <option value="BATCH_TRANSFER">🔄 โอนย้าย (Transfer)</option>
                            <option value="BATCH_OUTBOUND">💊 จ่ายยา (Outbound)</option>
                        </select>
                    </div>
                    <div class="mb-6 bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800">
                        <p class="font-bold mb-2"><i class="fa-solid fa-circle-info mr-1"></i> รูปแบบคอลัมน์ที่ต้องการ (เรียงตามลำดับ):</p>
                        <p id="template-guide" class="font-mono bg-white px-2 py-1 rounded border border-blue-200 break-words">
                            GenericName, TradeName, Form, Strength, Lot, ExpDate, Qty, Price
                        </p>
                    </div>
                    <div class="mb-8">
                         <div class="flex justify-between items-center mb-2">
                            <label class="form-label mb-0">2. เลือกไฟล์ .xlsx</label>
                            <button onclick="downloadTemplate()" class="text-sm text-blue-600 hover:text-blue-800 underline font-medium flex items-center gap-1"><i class="fa-solid fa-download"></i> ดาวน์โหลดไฟล์ตัวอย่าง (Template)</button>
                        </div>
                        <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 mb-3"></i>
                                <p class="text-sm text-gray-500">คลิกเพื่อเลือกไฟล์ Excel</p>
                            </div>
                            <input id="excel-file" type="file" class="hidden" accept=".xlsx, .csv" onchange="handleFileSelect(event)" />
                        </label>
                    </div>
                    <div id="import-preview" class="hidden mb-6">
                        <h3 class="font-bold text-gray-700 mb-2">ตัวอย่างข้อมูล (<span id="preview-count">0</span> รายการ)</h3>
                        <div class="overflow-x-auto border rounded-lg max-h-60">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-xs uppercase" id="preview-head"></thead>
                                <tbody class="bg-white divide-y" id="preview-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <button id="btn-import-confirm" onclick="submitImport()" disabled class="w-full bg-gray-300 text-white py-3 rounded-xl font-bold transition cursor-not-allowed">ยืนยันการนำเข้าข้อมูล</button>
                </div>
            </div>

            <!-- VIEW: ALERTS -->
            <div id="view-alerts" class="page-view admin-only hidden">
                <div class="max-w-6xl mx-auto space-y-6">
                    <div class="glass-panel p-6">
                        <div class="flex justify-between items-start mb-6 no-print">
                             <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-orange-600 text-2xl"><i class="fa-solid fa-bell"></i></div>
                                <div><h2 class="text-2xl font-bold text-gray-800">แจ้งเตือนสถานะคลังยา</h2><p class="text-gray-500">รายการยาที่ต้องเฝ้าระวังและจัดการ</p></div>
                            </div>
                            <button onclick="window.print()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-bold shadow-sm"><i class="fa-solid fa-print"></i> พิมพ์รายงาน</button>
                        </div>
                        <div class="hidden text-center mb-6" style="display: none;" id="print-header-alert">
                            <h1 class="text-xl font-bold">รายงานสถานะคลังยาและเวชภัณฑ์</h1>
                            <p class="text-sm">วันที่พิมพ์: <span class="print-date"></span></p>
                        </div>
                        <div class="mb-8">
                            <h3 class="text-lg font-bold text-red-600 mb-3 border-b border-red-200 pb-2 flex items-center gap-2"><i class="fa-solid fa-hourglass-half"></i> รายการยาใกล้หมดอายุ (ภายใน 6 เดือน)</h3>
                            <div class="overflow-x-auto border rounded-lg"><table class="w-full text-sm text-left" id="alert-expiry-table"><thead class="bg-red-50 text-red-800 uppercase text-xs"><tr><th class="px-4 py-3">ชื่อยา</th><th class="px-4 py-3">Lot No.</th><th class="px-4 py-3">วันหมดอายุ</th><th class="px-4 py-3 text-right">คงเหลือ</th><th class="px-4 py-3 text-center">คลัง</th></tr></thead><tbody class="divide-y text-gray-600 bg-white"></tbody></table></div>
                        </div>
                        <div class="mb-8">
                            <h3 class="text-lg font-bold text-orange-600 mb-3 border-b border-orange-200 pb-2 flex items-center gap-2"><i class="fa-solid fa-warehouse"></i> Stock คลังใหญ่ ใกล้หมด (น้อยกว่า 500)</h3>
                            <div class="overflow-x-auto border rounded-lg"><table class="w-full text-sm text-left" id="alert-low-main-table"><thead class="bg-orange-50 text-orange-800 uppercase text-xs"><tr><th class="px-4 py-3">ชื่อยา</th><th class="px-4 py-3">Lot No.</th><th class="px-4 py-3 text-right">คงเหลือ</th></tr></thead><tbody class="divide-y text-gray-600 bg-white"></tbody></table></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-yellow-600 mb-3 border-b border-yellow-200 pb-2 flex items-center gap-2"><i class="fa-solid fa-hospital-user"></i> Stock ห้องยา ใกล้หมด (น้อยกว่า 50)</h3>
                            <div class="overflow-x-auto border rounded-lg"><table class="w-full text-sm text-left" id="alert-low-opd-table"><thead class="bg-yellow-50 text-yellow-800 uppercase text-xs"><tr><th class="px-4 py-3">ชื่อยา</th><th class="px-4 py-3 text-right">คงเหลือ</th><th class="px-4 py-3 text-center">สถานะ</th></tr></thead><tbody class="divide-y text-gray-600 bg-white"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: REPORTS & EXPORT -->
            <div id="view-reports" class="page-view admin-only hidden">
                <div class="max-w-4xl mx-auto glass-panel p-8">
                    <div class="flex items-center gap-4 mb-8 border-b pb-4">
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-green-600 text-2xl"><i class="fa-solid fa-file-export"></i></div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">รายงานและการส่งออก (Reports & Export)</h2>
                            <p class="text-gray-500">ดาวน์โหลดข้อมูลประวัติการทำงานเป็นไฟล์ Excel</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Export Inbound -->
                        <div class="bg-white border rounded-xl p-6 hover:shadow-lg transition cursor-pointer group" onclick="exportLogs('INBOUND')">
                            <div class="flex items-center justify-between mb-4">
                                <div class="bg-blue-100 text-blue-600 p-3 rounded-lg"><i class="fa-solid fa-truck-medical text-xl"></i></div>
                                <i class="fa-solid fa-download text-gray-300 group-hover:text-blue-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mb-1">ประวัติการรับยาเข้า (Inbound)</h3>
                            <p class="text-sm text-gray-500">ส่งออกข้อมูลประวัติการรับยาเข้าคลังใหญ่ทั้งหมด</p>
                        </div>
                        <!-- Export Transfer -->
                        <div class="bg-white border rounded-xl p-6 hover:shadow-lg transition cursor-pointer group" onclick="exportLogs('TRANSFER')">
                            <div class="flex items-center justify-between mb-4">
                                <div class="bg-teal-100 text-teal-600 p-3 rounded-lg"><i class="fa-solid fa-dolly text-xl"></i></div>
                                <i class="fa-solid fa-download text-gray-300 group-hover:text-teal-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mb-1">ประวัติการเบิกยา (Transfer)</h3>
                            <p class="text-sm text-gray-500">ส่งออกข้อมูลประวัติการเบิกยาจากคลังใหญ่ไปห้องยา</p>
                        </div>
                        <!-- Export Outbound -->
                         <div class="bg-white border rounded-xl p-6 hover:shadow-lg transition cursor-pointer group" onclick="exportLogs('OUTBOUND')">
                            <div class="flex items-center justify-between mb-4">
                                <div class="bg-green-100 text-green-600 p-3 rounded-lg"><i class="fa-solid fa-hand-holding-medical text-xl"></i></div>
                                <i class="fa-solid fa-download text-gray-300 group-hover:text-green-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mb-1">ประวัติการจ่ายยา (Dispensing)</h3>
                            <p class="text-sm text-gray-500">ส่งออกข้อมูลประวัติการจ่ายยาให้ผู้ป่วย</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwt5RcoQApeQnPLiDhsmnX8nqwFh8ki1u0-LwVrzHutorifGF_gpZRQSGUJZcy9IGzdVw/exec'; 
        
        let stockData = { main: [], opd: [], logs: [] };
        let importData = [];
        let isLoggedIn = false;
        let currentFilterType = null; // Drug, Material, Equipment
        
        // Filter States for Dropdowns
        let transferFilter = 'All';
        let outboundFilter = 'All';

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
            document.querySelectorAll('.print-date').forEach(el => { el.innerText = new Date().toLocaleDateString('th-TH'); });
            checkLoginStatus();
            fetchData();
        });

        // --- AUTH ---
        function toggleLoginModal(show) { document.getElementById('login-modal').classList.toggle('hidden', !show); }
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if(document.getElementById('username').value === 'admin') {
                isLoggedIn = true;
                toggleLoginModal(false);
                checkLoginStatus();
                Swal.fire({ icon: 'success', title: 'ยินดีต้อนรับเภสัชกร', timer: 1500, showConfirmButton: false });
            }
        });
        function logout() { isLoggedIn = false; checkLoginStatus(); switchTab('dashboard'); toggleSidebar(false); }
        function checkLoginStatus() { document.body.classList.toggle('logged-in', isLoggedIn); }

        function toggleSidebar(forceOpen = null) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isVisible = !sidebar.classList.contains('-translate-x-full');
            if (forceOpen === true) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); setTimeout(() => overlay.style.opacity = '1', 10); } 
            else if (forceOpen === false) { sidebar.classList.add('-translate-x-full'); overlay.style.opacity = '0'; setTimeout(() => overlay.classList.add('hidden'), 300); } 
            else { if (isVisible) { sidebar.classList.add('-translate-x-full'); overlay.style.opacity = '0'; setTimeout(() => overlay.classList.add('hidden'), 300); } else { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); setTimeout(() => overlay.style.opacity = '1', 10); } }
        }
        
        function scrollToPanel(id) { const element = document.getElementById(id); if(element) { element.scrollIntoView({behavior: 'smooth', block: 'start'}); } }

        // --- DATA ---
        async function fetchData() {
            Swal.showLoading();
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'GET_INIT_DATA' }) }).then(r=>r.json());
                if(res.status === 'success') {
                    stockData.main = res.data.stockMain || [];
                    stockData.opd = res.data.stockOPD || [];
                    stockData.logs = res.data.logs || [];
                    
                    renderDashboard();
                    renderAlerts();
                    updateDatalist();
                    Swal.close();
                }
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        }

        // --- RENDER ---
        function switchTab(id, filterType = null) {
            document.querySelectorAll('.page-view').forEach(e => e.classList.add('hidden'));
            if(id === 'dashboard' || isLoggedIn) document.getElementById(`view-${id}`).classList.remove('hidden');
            else Swal.fire('Access Denied', 'Please Login', 'warning');
            
            toggleSidebar(false);

            if(id === 'dashboard') {
                currentFilterType = filterType;
                renderDashboard();
                let title = "ภาพรวมทั้งหมด (All Items)";
                if(filterType === 'Drug') title = "คลังยา (Drugs)";
                else if(filterType === 'Material') title = "วัสดุการแพทย์ (Medical Supplies)";
                else if(filterType === 'Equipment') title = "ครุภัณฑ์การแพทย์ (Medical Equipment)";
                document.getElementById('dashboard-title').innerText = title;
            }
            // Reset dropdowns when switching to operation tabs
            if(id === 'transfer') { setTransferFilter('All'); }
            if(id === 'outbound') { setOutboundFilter('All'); }
        }

        function switchInboundTab(type) {
            // Hide all forms
            document.getElementById('form-section-drug').classList.add('hidden');
            document.getElementById('form-section-material').classList.add('hidden');
            document.getElementById('form-section-equipment').classList.add('hidden');

            // Reset buttons
            const btns = ['drug', 'material', 'equipment'];
            btns.forEach(b => {
                const btn = document.getElementById(`tab-btn-${b}`);
                btn.classList.remove('bg-white', 'text-blue-700', 'shadow');
                btn.classList.add('text-gray-500', 'hover:bg-white/[0.12]', 'hover:text-white');
            });

            // Activate selected
            document.getElementById(`form-section-${type}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-btn-${type}`);
            activeBtn.classList.add('bg-white', 'text-blue-700', 'shadow');
            activeBtn.classList.remove('text-gray-500', 'hover:bg-white/[0.12]', 'hover:text-white');
        }

        function renderDashboard() {
            let mainList = stockData.main || [];
            let opdList = stockData.opd || [];
            if(currentFilterType) {
                mainList = mainList.filter(i => (i.ItemType === currentFilterType) || (!i.ItemType && currentFilterType === 'Drug'));
                opdList = opdList.filter(i => (i.ItemType === currentFilterType) || (!i.ItemType && currentFilterType === 'Drug'));
            }

            const mainItems = mainList.filter(i=>i.Qty>0).length;
            const opdItems = opdList.filter(i=>i.Qty>0).length;
            const totalVal = mainList.reduce((sum, i) => sum + (Number(i.Qty||0) * Number(i.Price||0)), 0);
            
            document.getElementById('stat-main-items').innerText = mainItems;
            document.getElementById('stat-opd-items').innerText = opdItems;
            document.getElementById('stat-value').innerText = totalVal.toLocaleString();
            document.getElementById('count-main').innerText = mainList.length + ' Items';
            document.getElementById('count-opd').innerText = opdList.length + ' Items';
            filterTables(mainList, opdList);
        }

        function renderTable(id, data, filter="") {
            const tbody = document.querySelector(`#${id} tbody`);
            tbody.innerHTML = '';
            if (!data) return;
            const filtered = data.filter(i => {
                if(!filter && i.Qty == 0) return false;
                const search = (i.GenericName + i.TradeName + i.Lot).toLowerCase();
                return search.includes(filter.toLowerCase());
            });
            if(filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">ไม่พบข้อมูล</td></tr>`; return; }
            filtered.forEach(i => {
                const tr = document.createElement('tr');
                tr.className = 'clickable-row border-b last:border-0 hover:bg-gray-50';
                tr.onclick = () => showDetail(i);
                let icon = '<i class="fa-solid fa-pills text-blue-400"></i>';
                if(i.ItemType === 'Material') icon = '<i class="fa-solid fa-bandage text-pink-400"></i>';
                if(i.ItemType === 'Equipment') icon = '<i class="fa-solid fa-stethoscope text-orange-400"></i>';
                const nameDisplay = `<div class="flex items-start gap-2"><div class="mt-1">${icon}</div><div><div class="font-bold text-gray-700">${i.TradeName || '-'}</div><div class="text-xs text-gray-500">${i.GenericName || i.DrugName}</div></div></div>`;
                const lotDisplay = `<div class="text-sm">${i.Lot}</div><div class="text-xs text-red-400">${formatDate(i.ExpDate)}</div>`;
                if(id === 'table-main') tr.innerHTML = `<td class="px-4 py-2">${nameDisplay}</td><td class="px-4 py-2">${lotDisplay}</td><td class="px-4 py-2 text-right font-bold text-blue-600">${Number(i.Qty).toLocaleString()}</td>`;
                else { let status = i.Qty > 0 ? '<span class="text-green-600 text-xs">● ปกติ</span>' : '<span class="text-gray-400 text-xs">● หมด</span>'; tr.innerHTML = `<td class="px-4 py-2">${nameDisplay}</td><td class="px-4 py-2">${status}</td><td class="px-4 py-2 text-right font-bold text-teal-600">${Number(i.Qty).toLocaleString()}</td>`; }
                tbody.appendChild(tr);
            });
        }
        
        function filterTables(main = stockData.main, opd = stockData.opd) {
            const val = document.getElementById('search-input').value;
            if(currentFilterType) {
                 main = main.filter(i => (i.ItemType === currentFilterType) || (!i.ItemType && currentFilterType === 'Drug'));
                 opd = opd.filter(i => (i.ItemType === currentFilterType) || (!i.ItemType && currentFilterType === 'Drug'));
            }
            renderTable('table-main', main, val);
            renderTable('table-opd', opd, val);
        }

        function showDetail(item) {
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-trade').innerText = item.TradeName || 'No Trade Name';
            document.getElementById('detail-generic').innerText = item.GenericName || item.DrugName;
            document.getElementById('detail-code24').innerText = item.DrugCode24 || '-';
            let badgeClass = 'bg-gray-200 text-gray-700';
            if(item.ItemType === 'Material') badgeClass = 'badge-material';
            else if(item.ItemType === 'Equipment') badgeClass = 'badge-equip';
            else badgeClass = 'badge-drug';
            const badge = document.getElementById('detail-type-badge'); badge.className = `badge ${badgeClass}`; badge.innerText = item.ItemType || 'Drug';
            document.getElementById('detail-form').innerText = item.DosageForm || '-';
            document.getElementById('detail-strength').innerText = item.Strength || '-';
            document.getElementById('detail-cat').innerText = item.Category || '-';
            document.getElementById('detail-ved').innerText = item.VED || '-';
            document.getElementById('detail-lot').innerText = item.Lot;
            document.getElementById('detail-exp').innerText = formatDate(item.ExpDate);
            document.getElementById('detail-qty').innerText = Number(item.Qty).toLocaleString();
            document.getElementById('detail-mfg').innerText = item.Manufacturer || '-';
            document.getElementById('detail-inv').innerText = item.InvoiceNo || '-';
            document.getElementById('detail-budget').innerText = item.BudgetYear || '-';
            document.getElementById('detail-price').innerText = Number(item.Price || 0).toLocaleString();
            const logs = (stockData.logs || []).filter(l => l.DrugID === item.DrugID).reverse();
            const logBody = document.getElementById('detail-history-body');
            logBody.innerHTML = logs.length ? '' : '<tr><td class="p-4 text-center text-gray-400">ไม่มีประวัติ</td></tr>';
            logs.forEach(l => { logBody.innerHTML += `<tr class="border-b"><td class="px-4 py-2 text-xs text-gray-500">${formatDate(l.Timestamp, true)}</td><td class="px-4 py-2 font-bold text-xs uppercase">${l.Type}</td><td class="px-4 py-2 text-right font-bold">${l.Qty}</td><td class="px-4 py-2 text-xs text-gray-500">${l.From} -> ${l.To}</td></tr>`; });
        }

        function toggleDetailModal(show) { document.getElementById('detail-modal').classList.toggle('hidden', !show); }
        
        // --- INBOUND AUTO FILL ---
        function updateDatalist() {
            const list = document.getElementById('existing-items-list');
            if(!stockData.main) return;
            const unique = [...new Map(stockData.main.map(item => [item.GenericName + item.TradeName, item])).values()];
            list.innerHTML = unique.map(i => `<option value="${i.TradeName ? i.TradeName + ' (' + i.GenericName + ')' : i.GenericName}">`).join('');
        }

        function autoFillInbound() {
            const val = document.getElementById('inbound-search-existing').value;
            if(!val) return;
            const found = stockData.main.find(i => (i.TradeName && val.includes(i.TradeName)) || (i.GenericName && val.includes(i.GenericName)));
            if(found) {
                // Determine Type and Switch Tab
                let type = 'drug';
                if(found.ItemType === 'Material') type = 'material';
                if(found.ItemType === 'Equipment') type = 'equipment';
                
                switchInboundTab(type); // Switch to correct form
                
                // Map common fields based on type
                const prefix = (type === 'drug') ? 'drug' : (type === 'material') ? 'mat' : 'eq';
                
                // Set values safely
                if(document.getElementById(`${prefix}-code24`)) document.getElementById(`${prefix}-code24`).value = found.DrugCode24 || ''; // or eq-code
                if(document.getElementById(`${prefix}-generic`)) document.getElementById(`${prefix}-generic`).value = found.GenericName || found.DrugName || ''; // mat-name, eq-name
                if(document.getElementById(`${prefix}-trade`)) document.getElementById(`${prefix}-trade`).value = found.TradeName || ''; // mat-brand, eq-brand
                
                // Special mapping
                if(type === 'drug') {
                     document.getElementById('drug-form').value = found.DosageForm || 'Tablet';
                     document.getElementById('drug-strength').value = found.Strength || '';
                     document.getElementById('drug-cat').value = found.Category || 'ED';
                     document.getElementById('drug-ved').value = found.VED || 'V';
                } else if (type === 'material') {
                     document.getElementById('mat-name').value = found.GenericName || '';
                     document.getElementById('mat-brand').value = found.TradeName || '';
                     document.getElementById('mat-unit').value = found.DosageForm || 'Piece';
                     document.getElementById('mat-spec').value = found.Strength || '';
                } else if (type === 'equipment') {
                     document.getElementById('eq-code').value = found.DrugCode24 || '';
                     document.getElementById('eq-name').value = found.GenericName || '';
                     document.getElementById('eq-brand').value = found.TradeName || '';
                }

                Swal.fire({
                    icon: 'success',
                    title: `พบข้อมูล: ${found.ItemType || 'Drug'}`,
                    text: 'สลับไปยังฟอร์มที่ถูกต้องและเติมข้อมูลให้แล้ว',
                    timer: 1500,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            }
        }

        // --- FILTER LOGIC FOR TRANSFER/OUTBOUND ---
        function setTransferFilter(type) {
            transferFilter = type;
            updateSelectOptions();
        }
        function setOutboundFilter(type) {
            outboundFilter = type;
            updateSelectOptions();
        }

        function updateSelectOptions() {
            // Helper to generate options
            const generateOptions = (data, filter) => {
                if(!data) return '';
                
                let filteredData = data;
                if(filter !== 'All') {
                    filteredData = data.filter(i => (i.ItemType === filter) || (!i.ItemType && filter === 'Drug'));
                }

                return '<option value="">-- เลือกรายการ --</option>' + 
                    filteredData.filter(i=>i.Qty>0).map(i => {
                        let typeLabel = '[Drug]';
                        if(i.ItemType === 'Material') typeLabel = '[Mat]';
                        if(i.ItemType === 'Equipment') typeLabel = '[Equip]';
                        
                        return `<option value='${JSON.stringify(i)}'>${typeLabel} ${i.TradeName||i.GenericName} (${i.Lot}) | คงเหลือ: ${i.Qty}</option>`
                    }).join('');
            };

            // Populate Transfer (from Main Stock)
            document.getElementById('transfer-select-item').innerHTML = generateOptions(stockData.main, transferFilter);
            
            // Populate Outbound (from OPD Stock)
            document.getElementById('outbound-select-item').innerHTML = generateOptions(stockData.opd, outboundFilter);

            // Adjust (Not filtered by type tabs, just location)
            const adjustLoc = document.getElementById('adjust-location').value;
            const adjustData = adjustLoc === 'Main' ? stockData.main : stockData.opd;
            document.getElementById('adjust-item').innerHTML = generateOptions(adjustData, 'All'); // Show all for adjust
        }

        // --- FORM HANDLERS ---
        // Generic function to attach listener to multiple forms
        ['form-inbound-drug', 'form-inbound-material', 'form-inbound-equipment'].forEach(id => {
            const form = document.getElementById(id);
            if(form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const payload = Object.fromEntries(fd.entries());
                    if(await sendAction('INBOUND', payload)) e.target.reset();
                });
            }
        });

        document.getElementById('form-transfer').addEventListener('submit', async (e) => {
            e.preventDefault();
            const val = document.getElementById('transfer-select-item').value;
            if(!val) return;
            const item = JSON.parse(val);
            const payload = {
                drugId: item.DrugID, drugName: item.DrugName, lot: item.Lot,
                qty: document.getElementById('transfer-qty').value,
                transferDate: document.getElementById('transfer-date').value,
                remark: document.getElementById('transfer-remark').value
            };
            if(await sendAction('TRANSFER', payload)) document.getElementById('form-transfer').reset();
        });

        async function submitOutbound() {
            const val = document.getElementById('outbound-select-item').value;
            if(!val) return;
            const item = JSON.parse(val);
            const payload = {
                drugId: item.DrugID, drugName: item.DrugName, lot: item.Lot,
                qty: document.getElementById('outbound-qty').value,
                dispenser: document.getElementById('outbound-by').value
            };
            if(await sendAction('OUTBOUND', payload)) document.getElementById('outbound-qty').value = '';
        }
        
         document.getElementById('form-adjust').addEventListener('submit', async (e) => {
            e.preventDefault();
            const val = document.getElementById('adjust-item').value;
            if(!val) return;
            const item = JSON.parse(val);
            const payload = {
                location: document.getElementById('adjust-location').value,
                drugId: item.DrugID, drugName: item.DrugName, lot: item.Lot,
                qty: document.getElementById('adjust-qty').value,
                type: document.getElementById('adjust-type').value,
                reason: document.getElementById('adjust-reason').value
            };
            if(await sendAction('ADJUST', payload)) document.getElementById('form-adjust').reset();
        });

        // --- EXPORT LOGIC ---
        function exportLogs(type) {
            let data = [];
            let filename = "";
            let logs = stockData.logs || [];
            if(type === 'INBOUND') {
                data = logs.filter(l => l.Type === 'INBOUND').map(l => ({ Date: formatDate(l.Timestamp, true), GenericName: l.GenericName || l.DrugName, Lot: l.Lot, Qty: l.Qty, Price: l.Price || '-', Invoice: l.InvoiceNo || '-' }));
                filename = "Inbound_History.xlsx";
            } else if (type === 'TRANSFER') {
                data = logs.filter(l => l.Type === 'TRANSFER').map(l => ({ Date: formatDate(l.Timestamp, true), Item: l.DrugName, Lot: l.Lot, Qty: l.Qty, Remark: l.Remark || '-' }));
                filename = "Transfer_History.xlsx";
            } else if (type === 'OUTBOUND') {
                data = logs.filter(l => l.Type === 'OUTBOUND').map(l => ({ Date: formatDate(l.Timestamp, true), Item: l.DrugName, Lot: l.Lot, Qty: l.Qty, Dispenser: l.Dispenser || '-' }));
                filename = "Outbound_History.xlsx";
            }
            if(data.length === 0) return Swal.fire('Info', 'ไม่พบข้อมูลในช่วงที่เลือก', 'info');
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, filename);
        }

        // --- HELPER & UTILS ---
        function renderAlerts() { /* ...Same as before... */
            const THRESHOLD_MAIN = 500; const THRESHOLD_OPD = 50;
            const today = new Date(); const sixMonthsLater = new Date(); sixMonthsLater.setMonth(today.getMonth() + 6);
            let expiringItems = [];
            (stockData.main || []).forEach(i => { if(i.ExpDate && i.Qty > 0) { const exp = new Date(i.ExpDate); if(exp <= sixMonthsLater) expiringItems.push({ ...i, Source: 'Main' }); } });
            (stockData.opd || []).forEach(i => { if(i.ExpDate && i.Qty > 0) { const exp = new Date(i.ExpDate); if(exp <= sixMonthsLater) expiringItems.push({ ...i, Source: 'OPD' }); } });

            const expiryTbody = document.getElementById('alert-expiry-table').querySelector('tbody');
            expiryTbody.innerHTML = expiringItems.length ? '' : '<tr><td colspan="5" class="p-4 text-center text-gray-400">ไม่มีรายการใกล้หมดอายุ</td></tr>';
            expiringItems.forEach(i => {
                const diffTime = new Date(i.ExpDate) - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const textColor = diffDays < 0 ? 'text-red-700 font-bold' : 'text-orange-600';
                expiryTbody.innerHTML += `<tr class="border-b"><td class="px-4 py-2 font-medium">${i.TradeName || i.GenericName}</td><td class="px-4 py-2 text-xs">${i.Lot}</td><td class="px-4 py-2 ${textColor}">${formatDate(i.ExpDate)} <span class="text-xs">(${diffDays} วัน)</span></td><td class="px-4 py-2 text-right font-bold">${Number(i.Qty).toLocaleString()}</td><td class="px-4 py-2 text-center text-xs"><span class="badge ${i.Source === 'Main' ? 'bg-blue-100 text-blue-800' : 'bg-teal-100 text-teal-800'}">${i.Source}</span></td></tr>`;
            });
            // Low Stock Main
            const lowMain = (stockData.main || []).filter(i => i.Qty > 0 && i.Qty < THRESHOLD_MAIN);
            const mainTbody = document.getElementById('alert-low-main-table').querySelector('tbody');
            mainTbody.innerHTML = lowMain.length ? '' : '<tr><td colspan="3" class="p-4 text-center text-gray-400">ไม่มีรายการเหลือน้อย</td></tr>';
            lowMain.forEach(i => { mainTbody.innerHTML += `<tr class="border-b"><td class="px-4 py-2 font-medium">${i.TradeName || i.GenericName}</td><td class="px-4 py-2 text-xs text-gray-500">${i.Lot}</td><td class="px-4 py-2 text-right font-bold text-orange-600">${Number(i.Qty).toLocaleString()}</td></tr>`; });
            // Low Stock OPD
            const lowOpd = (stockData.opd || []).filter(i => i.Qty > 0 && i.Qty < THRESHOLD_OPD);
            const opdTbody = document.getElementById('alert-low-opd-table').querySelector('tbody');
            opdTbody.innerHTML = lowOpd.length ? '' : '<tr><td colspan="3" class="p-4 text-center text-gray-400">ไม่มีรายการเหลือน้อย</td></tr>';
            lowOpd.forEach(i => { opdTbody.innerHTML += `<tr class="border-b"><td class="px-4 py-2 font-medium">${i.TradeName || i.GenericName} <span class="text-xs text-gray-400">(${i.Lot})</span></td><td class="px-4 py-2 text-right font-bold text-yellow-600">${Number(i.Qty).toLocaleString()}</td><td class="px-4 py-2 text-center text-xs text-red-500 font-bold">เติมด่วน!</td></tr>`; });
        }

        function updateTransferMax() { const val = document.getElementById('transfer-select-item').value; if(val) document.getElementById('transfer-max').innerText = JSON.parse(val).Qty; }
        function updateOutboundMax() { const val = document.getElementById('outbound-select-item').value; if(val) document.getElementById('outbound-max').innerText = JSON.parse(val).Qty; }
        function loadAdjustItems() { updateSelectOptions(); }
        function formatDate(d, time=false) { if(!d) return '-'; try { if(time) return new Date(d).toLocaleString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); return new Date(d).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }); } catch (e) { return new Date(d).toLocaleDateString(); } }
        
        // Same imports logic
        function updateTemplateInfo() { /* ... */ }
        function handleFileSelect(e) { /* ... */ }
        function processImport(rows) { /* ... */ }
        function resetImport() { /* ... */ }
        async function submitImport() { /* ... */ }
        function downloadTemplate() { /* ... */ }

        async function sendAction(action, payload) {
            Swal.fire({ title: 'Processing...', didOpen: () => Swal.showLoading() });
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, payload }) }).then(r=>r.json());
                if(res.status === 'success') {
                    await fetchData();
                    Swal.fire('Success', res.data.message, 'success');
                    return true;
                } else throw new Error(res.message);
            } catch(e) { Swal.fire('Error', e.message, 'error'); return false; }
        }
    </script>
</body>
</html>
